---
title: 你是否真的需要Service？
tags:
  - Android
  - Service
  - 杂谈
---
在项目中什么时候会使用到Service？对于这个问题，我最近有了自己的思考，欢迎大家拍砖并一起讨论。

作为四大组件之一的Service，相信大家对它一定不陌生，先让我们来看看官方文档是如何定义它的吧：

> `Service`是一个可以在后台执行长时间运行操作而不使用用户界面的应用组件。服务可由其他应用组件启动，而且即使用户切换到其他应用，服务仍将在后台继续运行。 此外，组件可以绑定到服务，以与之进行交互，甚至是执行进程间通信 (IPC)。 例如，服务可以处理网络事务、播放音乐，执行文件 I/O 或与内容提供程序交互，而所有这一切均可在后台进行。

定义中多次提及**后台**这个词，我对于它的理解，后台操作就是和UI无关逻辑，比如耗时的计算，读取本地大文件，下载操作等等。而前台操作就是显示一个图片，展示一段文字，播放一段动画等等。那么是不是所有和UI无关的操作都要写在Service里呢？我刚开始做安卓开发的时候，甚至直到做出一个完整App的时候，都没有用到过Service，程序照样跑得好好的，于是我认为，后台操作无非就是耗时操作嘛，大家都知道在主线程做耗时操作是会ANR的，那我开一个线程处理，不阻塞主线程不就完了，费那劲搞个Service干嘛？

直到我接到这么一个需求，要求在一个列表页的ListView里针对每一个表项分别进行网络操作，然后点进每个表项的详情页后，还能继续显示改项的网络操作进度，二级页面和一级页面的进度要同步。我一开始用老方法开线程，每个表项new一个。但一细想，不对啊，我跳到二级页面的时候，一级页面的线程就失去引用了，而且在Java中线程也是一个类，当一个线程被阻塞，被挂起，或者正在执行时，线程对象是不会被回收的，这还会导致Activity内存泄露。那就用，可是静态对象的生命周期和整个App是一致的，我离开这两个页面的时候，如果不主动释放，它将一直存在，同样导致资源的浪费，所以我必须在离开这两个页面的时候将线程关掉。

发现我程序的内存有些异常，后来我知道了那是内存泄露。在Java中非静态内部类的对象是持有外部类对象的引用的，我们在非静态内部类能够直接访问外部类的字段就是很好的证明。在Java中线程也是一个类，当一个线程被阻塞，被挂起，或者正在执行时，线程对象是不会被回收的。

为了解决上面这个问题，我把线程声明为静态类，然后把外部类对象作为弱引用传进去。这下不会内存泄露了，可是又有个问题，当前Activity结束后，我就失去了这个内部类对象的引用，被当做垃圾一同销毁了。。。打个比方，原本我在当前页面开启了一个下载操作，如果我退出当前Activity，再回来点击下载，不是继续原来的下载，而是重新开启一个新的下载线程，因为原来的对象已经找不到了。我还是不服，我又想到了把这个线程对象设为静态的，可是别的Activity想获取这个下载线程的时候又会出现问题，不断地修修补补，导致我的Activity十分臃肿，而且耦合度极高，难以复用。

使用静态内部类，传递参数进去，在Activity.onDestroy时设置停止标志位，倔强不服，坚持不用service，复用时遇到麻烦，

> 后台操作 != 耗时操作